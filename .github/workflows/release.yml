name: Release Workflow

run-name: "Release from run ${{ inputs.build_run_id }}"

on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: 'Build and Test workflow run ID'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read
      pull-requests: write
    outputs:
      new-version: ${{ steps.version.outputs.new_version }}
      branch-name: ${{ steps.version.outputs.branch_name }}
      commit-sha: ${{ steps.verify.outputs.commit_sha }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify build run exists and passed
        id: verify
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîç Checking workflow run ${{ inputs.build_run_id }}..."
          
          # Get the workflow run details
          RUN_DATA=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/runs/${{ inputs.build_run_id }})
          
          # Extract status and conclusion
          STATUS=$(echo "$RUN_DATA" | jq -r '.status')
          CONCLUSION=$(echo "$RUN_DATA" | jq -r '.conclusion')
          HEAD_SHA=$(echo "$RUN_DATA" | jq -r '.head_sha')
          HEAD_BRANCH=$(echo "$RUN_DATA" | jq -r '.head_branch')
          WORKFLOW_NAME=$(echo "$RUN_DATA" | jq -r '.name')
          
          echo "Workflow: $WORKFLOW_NAME"
          echo "Status: $STATUS"
          echo "Conclusion: $CONCLUSION"
          echo "Branch: $HEAD_BRANCH"
          echo "Commit SHA: $HEAD_SHA"
          
          # Check if run is from main branch
          if [ "$HEAD_BRANCH" != "main" ] && [ "$HEAD_BRANCH" != "master" ]; then
            echo "‚ùå Error: Build run must be from 'main' or 'master' branch"
            echo "   Found: '$HEAD_BRANCH'"
            echo "   This is a security measure to prevent releases from unreviewed branches."
            exit 1
          fi
          
          echo "‚úÖ Branch check passed: $HEAD_BRANCH"
          
          # Check if run completed successfully
          if [ "$STATUS" != "completed" ]; then
            echo "‚ùå Error: Workflow run is not completed (status: $STATUS)"
            exit 1
          fi
          
          if [ "$CONCLUSION" != "success" ]; then
            echo "‚ùå Error: Workflow run did not succeed (conclusion: $CONCLUSION)"
            exit 1
          fi
          
          echo "‚úÖ Build run verified successfully"
          echo "commit_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

      - name: Read and increment version
        id: version
        run: |
          if [ ! -f VERSION ]; then
            echo "‚ùå Error: VERSION file not found"
            exit 1
          fi
          
          CURRENT_VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "Current version: $CURRENT_VERSION"
          
          # Parse version (x.y.z)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          # Increment minor version, reset patch to 0
          NEW_MINOR=$((MINOR + 1))
          NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"
          
          BRANCH_NAME="rc-v${NEW_VERSION}"
          
          echo "New version: $NEW_VERSION"
          echo "Branch name: $BRANCH_NAME"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create release branch
        id: create_branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if branch exists remotely
          if git ls-remote --heads origin ${{ steps.version.outputs.branch_name }} | grep -q ${{ steps.version.outputs.branch_name }}; then
            echo "‚ùå Error: Branch '${{ steps.version.outputs.branch_name }}' already exists!"
            echo ""
            echo "This means a release for version ${{ steps.version.outputs.new_version }} has already been initiated."
            echo ""
            echo "Possible solutions:"
            echo "  1. If this is a retry, delete the existing branch first:"
            echo "     git push origin --delete ${{ steps.version.outputs.branch_name }}"
            echo "  2. If you need a new version, update the VERSION file in release branch"
            echo "  3. Check existing releases: https://github.com/${{ github.repository }}/branches"
            echo ""
            exit 1
          fi
          
          # Create and checkout new branch
          git checkout -b ${{ steps.version.outputs.branch_name }}
          
          # Update VERSION file
          echo "${{ steps.version.outputs.new_version }}" > VERSION
          
          # Commit and push
          git add VERSION
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
          git push origin ${{ steps.version.outputs.branch_name }}
          
          echo "‚úÖ Created branch ${{ steps.version.outputs.branch_name }}"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Retag and push image
        run: |
          # Construct the original image tag from the build run
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          ORIGINAL_TAG="${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}:${{ steps.verify.outputs.commit_sha }}"
          NEW_TAG="${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}:v${{ steps.version.outputs.new_version }}"
          
          echo "üì• Pulling original image..."
          docker pull $ORIGINAL_TAG
          
          echo "üè∑Ô∏è  Retagging image..."
          docker tag $ORIGINAL_TAG $NEW_TAG
          
          echo "üì§ Pushing new tag..."
          docker push $NEW_TAG
          
          echo "‚úÖ Successfully retagged and pushed image"
          echo "  Original: $ORIGINAL_TAG"
          echo "  New: $NEW_TAG"

      - name: Display summary
        run: |
          echo "## üöÄ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Information" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version**: v${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ steps.version.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Commit**: \`${{ steps.verify.outputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Run ID**: ${{ inputs.build_run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Run URL**: https://github.com/${{ github.repository }}/actions/runs/${{ inputs.build_run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Container Image" >> $GITHUB_STEP_SUMMARY
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          echo "- **Image**: \`${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}:v${{ steps.version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the release branch: [\`${{ steps.version.outputs.branch_name }}\`](https://github.com/${{ github.repository }}/tree/${{ steps.version.outputs.branch_name }})" >> $GITHUB_STEP_SUMMARY
          echo "2. Create a Pull Request to merge into main" >> $GITHUB_STEP_SUMMARY
          echo "3. Tag the release in GitHub" >> $GITHUB_STEP_SUMMARY

      - name: Download benchmark artifacts from build run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo " Downloading benchmark artifacts from run ${{ inputs.build_run_id }}..."
          
          # Download artifacts from the specified run
          gh run download ${{ inputs.build_run_id }} -n benchmark-results -D ./benchmarks
          
          if [ -f ./benchmarks/benchmark-results.json ]; then
            echo "‚úÖ Successfully downloaded benchmark results"
            cat ./benchmarks/benchmark-results.json | jq '.'
          else
            echo "‚ö†Ô∏è  Warning: benchmark-results.json not found"
            echo '{"error": "No benchmark data available"}' > ./benchmarks/benchmark-results.json
          fi

      - name: Generate release notes with benchmarks
        id: release_notes
        run: |
          # Read benchmark data
          BENCHMARK_JSON=$(cat ./benchmarks/benchmark-results.json)
          
          # Extract key metrics
          IMAGE_SIZE_MB=$(echo "$BENCHMARK_JSON" | jq -r '.image_info.size_mb // "N/A"')
          EXEC_TIME=$(echo "$BENCHMARK_JSON" | jq -r '.test_results.execution_time_ms // "N/A"')
          STARTUP_TIME=$(echo "$BENCHMARK_JSON" | jq -r '.benchmarks.container_startup_time_ms // "N/A"')
          MEMORY_USAGE=$(echo "$BENCHMARK_JSON" | jq -r '.benchmarks.memory_usage_mb // "N/A"')
          CPU_USAGE=$(echo "$BENCHMARK_JSON" | jq -r '.benchmarks.cpu_usage_percent // "N/A"')
          THROUGHPUT=$(echo "$BENCHMARK_JSON" | jq -r '.performance_metrics.throughput_requests_per_second // "N/A"')
          LATENCY_P50=$(echo "$BENCHMARK_JSON" | jq -r '.performance_metrics.latency_p50_ms // "N/A"')
          LATENCY_P95=$(echo "$BENCHMARK_JSON" | jq -r '.performance_metrics.latency_p95_ms // "N/A"')
          LATENCY_P99=$(echo "$BENCHMARK_JSON" | jq -r '.performance_metrics.latency_p99_ms // "N/A"')
          
          # Get lowercase image name
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          
          # Create release notes with actual values expanded
          cat > release-notes.md << EOF
          ## üéâ Release v${{ steps.version.outputs.new_version }}
          
          ### üì¶ Container Image
          
          \`\`\`bash
          docker pull ghcr.io/${IMAGE_NAME_LOWER}:v${{ steps.version.outputs.new_version }}
          \`\`\`
          
          ### üìä Performance Benchmarks
          
          #### Image Metrics
          | Metric | Value |
          |--------|-------|
          | **Image Size** | ${IMAGE_SIZE_MB} MB |
          | **Startup Time** | ${STARTUP_TIME} ms |
          | **Execution Time** | ${EXEC_TIME} ms |
          
          #### Resource Usage
          | Resource | Usage |
          |----------|-------|
          | **Memory** | ${MEMORY_USAGE} MB |
          | **CPU** | ${CPU_USAGE}% |
          
          #### Performance Metrics
          | Metric | Value |
          |--------|-------|
          | **Throughput** | ${THROUGHPUT} req/s |
          | **Latency (p50)** | ${LATENCY_P50} ms |
          | **Latency (p95)** | ${LATENCY_P95} ms |
          | **Latency (p99)** | ${LATENCY_P99} ms |
          
          ### üìà Benchmark Visualization
          
          \`\`\`
          Performance Overview:
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ Latency Distribution                ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          ‚îÇ p50: ${LATENCY_P50}ms ‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚îÇ
          ‚îÇ p95: ${LATENCY_P95}ms ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚îÇ
          ‚îÇ p99: ${LATENCY_P99}ms ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          
          Resource Utilization:
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ CPU:    ${CPU_USAGE}% ‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚îÇ
          ‚îÇ Memory: ${MEMORY_USAGE}MB ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          \`\`\`
          
          ### üîó Links
          
          - **Build Run**: https://github.com/${{ github.repository }}/actions/runs/${{ inputs.build_run_id }}
          - **Source Commit**: [\`${{ steps.verify.outputs.commit_sha }}\`](https://github.com/${{ github.repository }}/commit/${{ steps.verify.outputs.commit_sha }})
          - **Release Branch**: [\`${{ steps.version.outputs.branch_name }}\`](https://github.com/${{ github.repository }}/tree/${{ steps.version.outputs.branch_name }})
          
          ### üìù Full Benchmark Data
          
          <details>
          <summary>Click to expand full benchmark JSON</summary>
          
          \`\`\`json
          $(cat ./benchmarks/benchmark-results.json | jq '.')
          \`\`\`
          
          </details>
          EOF
          
          echo "‚úÖ Release notes generated"

      - name: Create Pull Request
        id: create_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üìù Creating Pull Request..."
          
          PR_BODY="## Release v${{ steps.version.outputs.new_version }}

          This PR prepares the release of version **v${{ steps.version.outputs.new_version }}**.

          ### Changes
          - ‚úÖ Version bumped from \`$(git show origin/main:VERSION | tr -d '[:space:]')\` to \`${{ steps.version.outputs.new_version }}\`
          - üê≥ Container image tagged and pushed: \`v${{ steps.version.outputs.new_version }}\`

          ### Build Information
          - **Build Run**: https://github.com/${{ github.repository }}/actions/runs/${{ inputs.build_run_id }}
          - **Source Commit**: \`${{ steps.verify.outputs.commit_sha }}\`

          ### Review Checklist
          - [ ] Version number is correct
          - [ ] Draft release is created, and release notes are correct. (Publish the release when you merge this PR)
          
          ---
          *This PR was automatically created by the Release workflow.*"
          
          PR_URL=$(gh pr create \
            --base main \
            --head ${{ steps.version.outputs.branch_name }} \
            --title "Release v${{ steps.version.outputs.new_version }}" \
            --body "$PR_BODY")
          
          echo "‚úÖ Pull Request created: $PR_URL"
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üéâ Creating GitHub Release..."
          
          gh release create "v${{ steps.version.outputs.new_version }}" \
            --title "Release v${{ steps.version.outputs.new_version }}" \
            --notes-file release-notes.md \
            --target ${{ steps.version.outputs.branch_name }} \
            --draft \
            ./benchmarks/benchmark-results.json#"Benchmark Results"
          
          echo "‚úÖ Draft release created for v${{ steps.version.outputs.new_version }}"
          echo "üìù Release is in DRAFT mode - review and publish manually"

      - name: Update workflow summary
        run: |
          echo "## ‚úÖ Release Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéâ Release v${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Request**: ${{ steps.create_pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release**: [v${{ steps.version.outputs.new_version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.new_version }}) (Draft)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Quick Benchmark Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          BENCHMARK_JSON=$(cat ./benchmarks/benchmark-results.json)
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image Size | $(echo "$BENCHMARK_JSON" | jq -r '.image_info.size_mb // "N/A"') MB |" >> $GITHUB_STEP_SUMMARY
          echo "| Startup Time | $(echo "$BENCHMARK_JSON" | jq -r '.benchmarks.container_startup_time_ms // "N/A"') ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Throughput | $(echo "$BENCHMARK_JSON" | jq -r '.performance_metrics.throughput_requests_per_second // "N/A"') req/s |" >> $GITHUB_STEP_SUMMARY
          echo "| Latency (p95) | $(echo "$BENCHMARK_JSON" | jq -r '.performance_metrics.latency_p95_ms // "N/A"') ms |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup on failure
        if: failure() && steps.create_branch.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üßπ Cleaning up due to workflow failure..."
          echo "Deleting branch: ${{ steps.version.outputs.branch_name }}"
          
          # Delete the branch we created
          git push origin --delete ${{ steps.version.outputs.branch_name }} || echo "Branch already deleted or doesn't exist"
          
          echo "‚úÖ Cleanup complete - branch removed"
